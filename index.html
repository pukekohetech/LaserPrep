<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SVG Laser Prep – Red Lines & Image Cleaner</title>
  <style>
    :root {
      --bg: #020617;
      --card-bg: #020617;
      --accent: #38bdf8;
      --accent-strong: #0ea5e9;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --radius-lg: 14px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.8);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 2rem;
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: var(--text-main);
    }

    .page { width: 100%; max-width: 900px; }

    h1 {
      margin: 0 0 0.5rem;
      font-size: 2rem;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    h1::after {
      content: "Laser-Ready";
      font-size: 0.75rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent-strong);
      border: 1px solid rgba(56, 189, 248, 0.3);
      letter-spacing: 0.12em;
    }

    .subtitle { margin: 0 0 1rem; color: var(--text-soft); }

    .card {
      margin-top: 1rem;
      padding: 1.2rem 1.4rem;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148,163,184,0.25);
      box-shadow: var(--shadow-soft);
    }

    .card-main {
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.35), transparent 65%),
        #020617;
      border-color: rgba(56,189,248,0.4);
    }

    .file-row {
      display: flex;
      gap: 0.7rem;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 0.8rem;
    }

    input[type="file"] { color: var(--text-soft); }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.55rem 1.2rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #020617;
      box-shadow: 0 12px 30px rgba(56,189,248,0.25);
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      background: #4b5563;
      color: #cbd5f5;
      box-shadow: none;
    }

    /* Secondary PDF button */
    #pdfBtn {
      background: transparent;
      border: 1px solid rgba(148,163,184,0.7);
      color: var(--text-main);
      box-shadow: none;
    }
    #pdfBtn:disabled { opacity: 0.25; }

    .slider-row {
      display: flex;
      gap: 0.7rem;
      align-items: center;
      margin-bottom: 0.8rem;
      padding: 0.6rem;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.3);
      background: rgba(15,23,42,0.8);
    }

    input[type="range"] {
      width: 200px;
      appearance: none;
      height: 6px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid rgba(148,163,184,0.5);
    }

    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      border: 2px solid #020617;
    }

    #log, #preview {
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 10px;
      padding: 0.7rem;
      max-height: 260px;
      overflow: auto;
      font-size: 0.85rem;
    }

    #preview { max-height: 420px; }

    #preview svg {
      background: white;
      border-radius: 6px;
      max-width: 100%;
      height: auto;
      display: block;
      margin: auto;
    }
  </style>
</head>

<body>
<div class="page">
  <h1>SVG Laser Prep</h1>
  <p class="subtitle">Fix red cut lines and clean embedded images for laser cutting.</p>

  <div class="card card-main">
    <p><b>Upload an SVG</b> to fix red lines and clean embedded images.</p>

    <div class="file-row">
      <input type="file" id="fileInput" accept=".svg,image/svg+xml" />
      <button id="processBtn" disabled>Process SVG</button>
      <button id="pdfBtn" disabled>Save as PDF</button>
    </div>

    <div class="slider-row">
      <label><b>Contrast:</b></label>
      <input type="range" id="contrast" min="0.3" max="2" step="0.05" value="1">
      <span id="contrastValue">1.00×</span>
    </div>

    <p><b>Download:</b> <span id="downloadContainer">No file yet.</span></p>
  </div>

  <div class="card">
    <h2>Log</h2>
    <div id="log">Waiting for file…</div>
  </div>

  <div class="card">
    <h2>Preview</h2>
    <div id="preview">No preview yet.</div>
  </div>
</div>

<script>
/* ---------------- ENTIRE ORIGINAL JS + PDF EXPORT ---------------- */

const fileInput = document.getElementById("fileInput");
const processBtn = document.getElementById("processBtn");
const pdfBtn = document.getElementById("pdfBtn");
const contrastInput = document.getElementById("contrast");
const contrastValue = document.getElementById("contrastValue");
const logEl = document.getElementById("log");
const previewEl = document.getElementById("preview");
const downloadContainer = document.getElementById("downloadContainer");

let currentSvgText = "";
let currentFileName = "";
let currentContrast = 1;

contrastInput.addEventListener("input", () => {
  currentContrast = parseFloat(contrastInput.value);
  contrastValue.textContent = currentContrast.toFixed(2) + "×";
});

fileInput.addEventListener("change", () => {
  const file = fileInput.files[0];
  if (!file) return;

  if (!file.name.toLowerCase().endsWith(".svg")) {
    logEl.textContent = "Please select an SVG.";
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    currentSvgText = e.target.result;
    currentFileName = file.name;
    processBtn.disabled = false;
    logEl.textContent = "Loaded: " + file.name;
  };
  reader.readAsText(file);
});

processBtn.addEventListener("click", async () => {
  logEl.textContent = "Processing…";
  const out = await processSvg(currentSvgText, currentContrast);

  previewEl.innerHTML = out.innerSvg;
  logEl.textContent = out.summary;

  const blob = new Blob([out.svgText], { type: "image/svg+xml" });
  const url = URL.createObjectURL(blob);

  downloadContainer.innerHTML =
    `<a href="${url}" download="${currentFileName.replace('.svg','')}_fixed.svg">Download fixed SVG</a>`;

  pdfBtn.disabled = false;
});

/* ---------------- VECTOR PDF EXPORT ---------------- */
pdfBtn.addEventListener("click", () => {
  const svg = previewEl.querySelector("svg");
  if (!svg) { alert("Process an SVG first."); return; }

  const w = window.open("", "_blank");
  w.document.write(`
    <html>
    <head>
      <title>${currentFileName}</title>
      <style>
        @page { size: A4; margin: 10mm; }
        body { margin: 0; background: white; display: flex; justify-content: center; }
        svg { max-width: 95%; max-height: 95vh; }
      </style>
    </head>
    <body></body>
    </html>
  `);

  w.document.body.appendChild(svg.cloneNode(true));
  setTimeout(() => w.print(), 200);
});

/* ---------------- SVG PROCESSING ---------------- */

async function processSvg(svgText, contrast) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(svgText, "image/svg+xml");
  const svg = doc.documentElement;

  let total = 0, redFound = 0;

  svg.querySelectorAll("*").forEach(el => {
    total++;
    const stroke = (el.getAttribute("stroke") || "").toLowerCase();

    if (["#ff0000","#f00","red","rgb(255,0,0)"].includes(stroke)) {
      redFound++;
      el.setAttribute("stroke", "rgb(255,0,0)");
      el.setAttribute("stroke-width", "0.1px");
      el.setAttribute("stroke-opacity", "1");
    }
  });

  let imagesProcessed = 0;
  const images = svg.querySelectorAll("image");
  const xlinkNS = "http://www.w3.org/1999/xlink";

  for (const img of images) {
    const href =
      img.getAttributeNS(xlinkNS, "href") ||
      img.getAttribute("href");

    if (!href || !href.startsWith("data:image")) continue;

    const cleaned = await processImage(href, contrast);
    img.setAttributeNS(xlinkNS, "href", cleaned);
    img.removeAttribute("href");
    imagesProcessed++;
  }

  const finalSvg = new XMLSerializer().serializeToString(svg);

  return {
    svgText: finalSvg,
    innerSvg: finalSvg,
    summary:
      `=== SVG Laser Prep ===\n` +
      `Elements scanned: ${total}\n` +
      `Red lines fixed: ${redFound}\n` +
      `Images cleaned: ${imagesProcessed}\n` +
      `Contrast: ${contrast.toFixed(2)}×`
  };
}

function processImage(dataUrl, contrast) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      const c = document.createElement("canvas");
      c.width = img.width; c.height = img.height;
      const ctx = c.getContext("2d");

      ctx.drawImage(img, 0, 0);
      const imageData = ctx.getImageData(0, 0, c.width, c.height);
      const d = imageData.data;

      for (let i = 0; i < d.length; i += 4) {
        let grey = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
        grey = (grey - 128) * contrast + 128;
        grey = Math.min(255, Math.max(0, grey));

        d[i] = d[i+1] = d[i+2] = grey;

        if (grey > 240) d[i+3] = 0;
      }

      ctx.putImageData(imageData, 0, 0);
      resolve(c.toDataURL("image/png"));
    };
    img.src = dataUrl;
  });
}

</script>

</body>
</html>
